trigger:
- none

resources:
- repo: self

variables:
  nextjsRepository: 'nextjs'
  nginxRepository: 'nginx'

  dockerRegistryServiceConnection: 'e3e6799a-1f72-4998-bfc2-7cdafd464719'
  containerRegistry: 'ferndocker.azurecr.io'
  imagePullSecret: 'ferndocker1265143b-auth'

  vmImageName: 'ubuntu-latest'
  projectName: 'frontend'
  

stages:
- stage: Build
  displayName: Build stage
  jobs:  
  - job: Build
    displayName: Build NextJS and NGINX
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: DockerCompose@0
      inputs:
        containerregistrytype: 'Azure Container Registry'
        azureSubscription: 'Azure subscription 1(f7c1860a-e055-4556-81d2-8c9174ca8021)'
        azureContainerRegistry: '{"loginServer":"ferndocker.azurecr.io", "id" : "/subscriptions/f7c1860a-e055-4556-81d2-8c9174ca8021/resourceGroups/Fern/providers/Microsoft.ContainerRegistry/registries/FernDocker"}'
        dockerComposeFile: 'docker-compose.yml'
        projectName: $(projectName)
        action: 'Build services'
        includeLatestTag: true
    - task: DockerCompose@0
      inputs:
        containerregistrytype: 'Azure Container Registry'
        azureSubscription: 'Azure subscription 1(f7c1860a-e055-4556-81d2-8c9174ca8021)'
        azureContainerRegistry: '{"loginServer":"ferndocker.azurecr.io", "id" : "/subscriptions/f7c1860a-e055-4556-81d2-8c9174ca8021/resourceGroups/Fern/providers/Microsoft.ContainerRegistry/registries/FernDocker"}'
        dockerComposeFile: 'docker-compose.yml'
        projectName: $(projectName)
        action: 'Push services'
        includeLatestTag: true
          
    - upload: manifests/nextjs
      artifact: manifests/nextjs
      
    - upload: manifests/nginx
      artifact: manifests/nginx

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build

  jobs:
  - deployment: DeployNextJs
    displayName: Deploy NextJS and NGINX
    pool:
      vmImage: $(vmImageName)
    environment: 'ImStevemmmmmfernfrontend-4579.default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: KubernetesManifest@0
            displayName: Create imagePullSecret
            inputs:
              action: createSecret
              secretName: $(imagePullSecret)
              dockerRegistryEndpoint: $(dockerRegistryServiceConnection)
              
          - task: KubernetesManifest@0
            displayName: Deploy to Kubernetes cluster
            inputs:
              action: deploy
              manifests: |
                $(Pipeline.Workspace)/manifests/nextjs/deployment.yml
                $(Pipeline.Workspace)/manifests/nextjs/service.yml
                $(Pipeline.Workspace)/manifests/nginx/deployment.yml
                $(Pipeline.Workspace)/manifests/nginx/service.yml
              imagePullSecrets: |
                $(imagePullSecret)
              containers: |
                $(containerRegistry)/$(nextjsRepository):latest
                $(containerRegistry)/$(nginxRepository):latest
